# セキュリティガイド

## 2つの責任

Claude Codeを使う開発者には2つのセキュリティ責任があります。

| 責任 | 守るもの | 主なリスク |
|-----|---------|----------|
| **開発環境を守る** | APIキー、認証情報、ソースコード | プロンプトインジェクション、悪意のあるMCP |
| **ユーザーを守る** | エンドユーザーのデータ | 脆弱なコード生成、設定ミス |

---

## 開発環境を守る

### 1. 機密ファイルへのアクセス制限

**settings.json で制限を設定：**

```json
{
  "permissions": {
    "deny": [
      "Read(./.env)",
      "Read(./.env.local)",
      "Read(./.env.production)",
      "Read(~/.ssh/*)",
      "Read(~/.aws/*)"
    ]
  }
}
```

### 2. サンドボックスモードの活用

未知のスクリプトや破壊的な操作を行う場合：

```
/sandbox
```

**サンドボックスの保護範囲：**
- ファイルシステム：作業ディレクトリのみアクセス可能
- ネットワーク：許可リストのドメインのみ接続可能

### 3. MCPサーバーの導入チェック

新しいMCPサーバーを導入する前に確認：

| チェック項目 | 確認内容 |
|-------------|---------|
| 公式性 | 開発元は信頼できるか？ |
| 実績 | GitHubスター数、ダウンロード数 |
| 権限 | 機密情報へのアクセスはないか？ |
| コード | オープンソースで監査可能か？ |

---

## ユーザーを守る

### 1. AIへの指示にセキュリティ要件を含める

**悪い例：**
```
ユーザー登録機能を作って
```

**良い例：**
```
ユーザー登録機能を作ってください。

セキュリティ要件：
- パスワードはbcryptでハッシュ化
- メールアドレスの重複チェック
- 入力値のバリデーション（XSS対策）
- レート制限（1分間に5回まで）
```

### 2. OWASP Top 10 チェックリスト

生成されたコードを確認する際のチェックポイント：

#### インジェクション対策
- [ ] SQLはプリペアドステートメント/ORMを使用
- [ ] ユーザー入力は必ずサニタイズ
- [ ] `dangerouslySetInnerHTML`使用時はDOMPurify適用

#### アクセス制御
- [ ] 認証チェックが全APIに存在
- [ ] ユーザーIDベースの権限検証
- [ ] 管理者機能へのアクセス制限

#### 設定ミス防止
- [ ] Firebase/Supabaseのセキュリティルールを確認
- [ ] CORSは必要最小限のオリジンのみ許可
- [ ] 本番環境でデバッグモードが無効

### 3. 依存関係の監視

```bash
# npm の脆弱性チェック
npm audit

# 自動修正（マイナーアップデートのみ）
npm audit fix

# pnpm の場合
pnpm audit
```

**CI/CDに組み込む：**
```yaml
# .github/workflows/security.yml
- name: Security audit
  run: npm audit --audit-level=high
```

---

## セキュリティチェックリスト

### 開発開始時

- [ ] `.env`ファイルを`.gitignore`に追加
- [ ] `settings.json`で機密ファイルの読み取りを禁止
- [ ] `.claudeignore`で除外ファイルを設定

### コード生成後

- [ ] 認証・認可ロジックをレビュー
- [ ] ユーザー入力の処理をレビュー
- [ ] データベースクエリをレビュー
- [ ] 外部API呼び出しをレビュー

### リリース前

- [ ] `npm audit`で脆弱性チェック
- [ ] セキュリティヘッダーの設定確認
- [ ] 本番環境の環境変数設定確認
- [ ] ログに機密情報が出力されないか確認

---

## 推奨ツール

### 静的解析

| ツール | 用途 |
|-------|------|
| SonarQube | 包括的なコード品質・セキュリティ分析 |
| CodeQL | GitHub統合のセキュリティスキャン |
| ESLint security plugin | JavaScriptのセキュリティルール |

### 依存関係監視

| ツール | 用途 |
|-------|------|
| Dependabot | 脆弱性の自動検出・PR作成 |
| Snyk | リアルタイム脆弱性監視 |
| Socket.dev | npm パッケージの挙動監視 |

### 設定例

**package.json:**
```json
{
  "scripts": {
    "security:audit": "npm audit --audit-level=high",
    "security:check": "eslint --plugin security src/"
  }
}
```

---

## 事例から学ぶ

### CamoLeak脆弱性（2024年）

**何が起きたか：**
- GitHub PRに隠しプロンプトを埋め込み
- Copilotが`.env`の内容を外部に送信

**教訓：**
- 機密ファイルへのアクセスを制限する
- 外部からのプロンプト注入に注意

### Tea事件（2025年）

**何が起きたか：**
- Firebaseの設定ミス（`allow read: if true`）
- 72,000件の画像が流出

**教訓：**
- 「動いた」で満足しない
- BaaSのセキュリティルールを必ず確認
- アクセス制御は人間がレビュー
